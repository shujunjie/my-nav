<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyNav - 个人聚合导航 (Admin Ver)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #0f1115;
            color: #e2e8f0;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f1115; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .card-hoverable { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hoverable:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(51, 65, 85, 0.8);
        }
        /* Admin specific styles */
        .admin-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            width: 100%;
        }
        .admin-input:focus { outline: none; border-color: #3b82f6; }
        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-content { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Supabase Config ---
        const supabaseUrl = 'https://tbyzgsmsyrcpfopsezix.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRieXpnc21zeXJjcGZvcHNleml4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNTQwMjgsImV4cCI6MjA3OTYzMDAyOH0._eLHy9ajLM7UDQQl6Yp7bbA3V2pYXTTDIlRqecPjbZI';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- Icons List for Picker ---
        const commonIcons = [
            'fa-solid fa-link', 'fa-brands fa-tiktok', 'fa-brands fa-bilibili', 'fa-brands fa-youtube',
            'fa-brands fa-weixin', 'fa-brands fa-qq', 'fa-brands fa-weibo', 'fa-brands fa-github',
            'fa-solid fa-envelope', 'fa-solid fa-robot', 'fa-solid fa-brain', 'fa-solid fa-cloud',
            'fa-solid fa-gamepad', 'fa-solid fa-music', 'fa-solid fa-image', 'fa-solid fa-film'
        ];

        // --- Color Options ---
        const colorOptions = [
            { label: 'Blue', bg: 'bg-blue-600', text: 'text-blue-400' },
            { label: 'Purple', bg: 'bg-purple-600', text: 'text-purple-400' },
            { label: 'Pink', bg: 'bg-pink-600', text: 'text-pink-400' },
            { label: 'Red', bg: 'bg-red-600', text: 'text-red-400' },
            { label: 'Orange', bg: 'bg-orange-600', text: 'text-orange-400' },
            { label: 'Green', bg: 'bg-green-600', text: 'text-green-400' },
            { label: 'Teal', bg: 'bg-teal-600', text: 'text-teal-400' },
            { label: 'Black', bg: 'bg-gray-800', text: 'text-gray-400' },
        ];

        // --- Helper: Get Favicon URL ---
        const getFaviconUrl = (url) => {
            try {
                const domain = new URL(url).hostname;
                return `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
            } catch (e) {
                return '';
            }
        };

        // --- Components ---

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, []);

            const bgClass = type === 'error' ? 'bg-red-500' : 'bg-green-500';

            return (
                <div className={`fixed top-4 right-4 z-[100] ${bgClass} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-[slideIn_0.3s_ease-out]`}>
                    <i className={`fa-solid ${type === 'error' ? 'fa-circle-exclamation' : 'fa-check-circle'}`}></i>
                    <span className="text-sm font-medium">{message}</span>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 modal-overlay">
                    <div className="bg-[#1e293b] border border-white/10 p-6 rounded-xl shadow-2xl max-w-sm w-full modal-content">
                        <h3 className="text-lg font-bold text-white mb-2">{title}</h3>
                        <p className="text-gray-400 mb-6 text-sm leading-relaxed">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-300 text-sm transition-colors">取消</button>
                            <button onClick={onConfirm} className="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-white font-bold text-sm transition-colors shadow-lg shadow-red-900/50">确认删除</button>
                        </div>
                    </div>
                </div>
            );
        };

        const TimeWidget = () => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            return (
                <div className="glass-panel p-6 rounded-2xl flex flex-col items-center justify-center h-40 relative overflow-hidden group">
                    <div className="absolute top-3 left-4 text-xs font-bold text-gray-400 tracking-wider">TIME</div>
                    <div className="text-6xl font-mono font-bold tracking-tight text-white flex items-baseline">
                        <span>{String(time.getHours()).padStart(2, '0')}</span>
                        <span className="animate-pulse mx-1 text-gray-500">:</span>
                        <span>{String(time.getMinutes()).padStart(2, '0')}</span>
                    </div>
                    <div className="text-sm font-mono text-gray-400 mt-1">{String(time.getSeconds()).padStart(2, '0')}s</div>
                </div>
            );
        };

        const DateWidget = () => {
            const [date] = useState(new Date());
            const dayMap = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            return (
                <div className="glass-panel p-6 rounded-2xl flex flex-col items-center justify-center h-40 relative overflow-hidden">
                    <div className="absolute top-3 left-4 text-xs font-bold text-gray-400 tracking-wider">TODAY</div>
                    <div className="text-6xl font-bold text-white">{date.getDate()}</div>
                    <div className="flex flex-col items-center mt-1">
                        <span className="text-sm text-gray-300 font-medium">{dayMap[date.getDay()]}</span>
                        <span className="text-xs text-gray-500 mt-0.5">{date.getFullYear()}年{date.getMonth() + 1}月</span>
                    </div>
                </div>
            );
        };

        const SearchWidget = () => {
            const [engine, setEngine] = useState('baidu');
            const [query, setQuery] = useState('');
            const engines = {
                baidu: { name: 'Baidu', url: 'https://www.baidu.com/s?wd=', placeholder: '百度一下' },
                google: { name: 'Google', url: 'https://www.google.com/search?q=', placeholder: 'Google Search' },
                bing: { name: 'Bing', url: 'https://www.bing.com/search?q=', placeholder: 'Bing Search' }
            };
            const handleSearch = (e) => {
                e.preventDefault();
                if (!query.trim()) return;
                window.open(engines[engine].url + encodeURIComponent(query), '_blank');
                setQuery('');
            };
            return (
                <div className="glass-panel p-6 rounded-2xl h-40 flex flex-col justify-between relative bg-gradient-to-br from-blue-600/20 to-transparent border-blue-500/30 border">
                    <div className="absolute top-3 left-4 text-xs font-bold text-blue-300 tracking-wider">常用搜索</div>
                    <form onSubmit={handleSearch} className="mt-4 w-full relative group">
                        <i className="fa-solid fa-magnifying-glass absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" value={query} onChange={(e) => setQuery(e.target.value)}
                            className="w-full bg-black/40 border border-white/10 text-white text-sm rounded-xl py-3 pl-10 pr-4 focus:outline-none focus:border-blue-500 transition-all placeholder-gray-500"
                            placeholder={engines[engine].placeholder} />
                    </form>
                    <div className="flex gap-2 mt-2">
                        {Object.keys(engines).map(key => (
                            <button key={key} onClick={() => setEngine(key)}
                                className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${engine === key ? 'bg-white text-black' : 'bg-white/5 text-gray-400 hover:bg-white/10'}`}>
                                {engines[key].name}
                            </button>
                        ))}
                         <button onClick={handleSearch} className="ml-auto px-4 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-lg transition-colors">搜索</button>
                    </div>
                </div>
            );
        };

        // --- LinkCard Component (Modified for Image Support) ---
        const LinkCard = ({ link }) => {
            const isImage = link.icon && (link.icon.startsWith('http') || link.icon.startsWith('data:'));

            return (
                <a href={link.url} target={link.url.startsWith('http') ? "_blank" : "_self"} rel="noopener noreferrer"
                    className="glass-panel p-4 rounded-xl flex items-center gap-4 card-hoverable group relative overflow-hidden">
                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-white text-xl shadow-lg shrink-0 ${link.color || 'bg-gray-700'} relative z-10 overflow-hidden`}>
                        {isImage ? (
                            <img src={link.icon} alt={link.name} className="w-8 h-8 object-contain" />
                        ) : (
                            <i className={link.icon || 'fa-solid fa-link'}></i>
                        )}
                    </div>
                    <div className="flex flex-col overflow-hidden z-10">
                        <h3 className="text-gray-100 font-bold text-sm truncate group-hover:text-blue-300 transition-colors">
                            {link.name} {link.special && <span className="ml-2 text-[10px] bg-white/20 px-1.5 py-0.5 rounded text-white/80 font-normal">APP</span>}
                        </h3>
                        <p className="text-gray-500 text-xs truncate mt-0.5 group-hover:text-gray-400 transition-colors">{link.desc || '暂无描述'}</p>
                    </div>
                </a>
            );
        };

        // --- Admin Components ---

        const AdminModal = ({ title, onClose, children }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
                <div className="glass-panel bg-[#1a1d24] w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] modal-content">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                        <h3 className="text-lg font-bold text-white">{title}</h3>
                        <button onClick={onClose} className="text-gray-400 hover:text-white"><i className="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                    <div className="p-6 overflow-y-auto custom-scrollbar flex-1">
                        {children}
                    </div>
                </div>
            </div>
        );

        // --- LinkEditor Component (Modified for AI Auto Fetch) ---
        const LinkEditor = ({ link, onSave, onCancel }) => {
            const [formData, setFormData] = useState(link || { name: '', url: '', desc: '', icon: 'fa-solid fa-link', color: 'bg-gray-700', special: false });
            const [fetchingIcon, setFetchingIcon] = useState(false);

            const handleAutoFetchIcon = () => {
                if (!formData.url || !formData.url.startsWith('http')) {
                    alert('请先输入有效的网址 (http/https)');
                    return;
                }
                setFetchingIcon(true);
                const iconUrl = getFaviconUrl(formData.url);
                // Simulate a small delay for better UX feel or assume instant
                setTimeout(() => {
                    setFormData({ ...formData, icon: iconUrl });
                    setFetchingIcon(false);
                }, 500);
            };

            const isImage = formData.icon && (formData.icon.startsWith('http') || formData.icon.startsWith('data:'));

            return (
                <div className="space-y-4">
                    <div>
                        <label className="block text-xs text-gray-400 mb-1">名称</label>
                        <input type="text" className="admin-input" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} placeholder="例如: 哔哩哔哩" />
                    </div>
                    <div>
                        <label className="block text-xs text-gray-400 mb-1">链接 (URL)</label>
                        <div className="flex gap-2">
                             <input type="text" className="admin-input" value={formData.url} onChange={e => setFormData({...formData, url: e.target.value})} placeholder="https://..." />
                        </div>
                    </div>
                    <div>
                        <label className="block text-xs text-gray-400 mb-1">描述</label>
                        <input type="text" className="admin-input" value={formData.desc} onChange={e => setFormData({...formData, desc: e.target.value})} placeholder="简短描述" />
                    </div>
                    <div>
                        <div className="flex justify-between items-center mb-1">
                            <label className="block text-xs text-gray-400">图标 (支持 FontAwesome 类名 或 图片URL)</label>
                            <button 
                                onClick={handleAutoFetchIcon} 
                                disabled={fetchingIcon}
                                className="text-[10px] bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-0.5 rounded flex items-center gap-1 transition-colors disabled:opacity-50">
                                {fetchingIcon ? <i className="fa-solid fa-spinner fa-spin"></i> : <i className="fa-solid fa-wand-magic-sparkles"></i>}
                                自动获取图标
                            </button>
                        </div>
                        <div className="flex gap-2">
                             <input type="text" className="admin-input" value={formData.icon} onChange={e => setFormData({...formData, icon: e.target.value})} placeholder="fa-solid fa-link 或 https://..." />
                             <div className="w-10 h-10 flex items-center justify-center bg-white/10 rounded overflow-hidden shrink-0">
                                 {isImage ? <img src={formData.icon} className="w-6 h-6 object-contain" /> : <i className={formData.icon}></i>}
                             </div>
                        </div>
                        
                        {/* Only show FontAwesome picker if not using an image URL */}
                        {!isImage && (
                            <div className="flex gap-2 mt-2 overflow-x-auto pb-2">
                                {commonIcons.map(icon => (
                                    <button key={icon} onClick={() => setFormData({...formData, icon})} className={`p-2 rounded hover:bg-white/20 ${formData.icon === icon ? 'bg-blue-500/50' : 'bg-white/5'}`}>
                                        <i className={icon}></i>
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                     <div>
                        <label className="block text-xs text-gray-400 mb-1">卡片颜色 (图片图标建议使用深色背景)</label>
                        <div className="flex flex-wrap gap-2">
                            {colorOptions.map(opt => (
                                <button key={opt.bg} onClick={() => setFormData({...formData, color: opt.bg})} 
                                    className={`w-8 h-8 rounded-full ${opt.bg} ${formData.color === opt.bg ? 'ring-2 ring-white ring-offset-2 ring-offset-black' : 'opacity-70 hover:opacity-100'}`} 
                                    title={opt.label}></button>
                            ))}
                        </div>
                    </div>
                    <div className="flex items-center gap-2">
                         <input type="checkbox" id="special" checked={formData.special || false} onChange={e => setFormData({...formData, special: e.target.checked})} />
                         <label htmlFor="special" className="text-sm text-gray-300">特殊应用 (如微信/QQ协议链接)</label>
                    </div>
                    <div className="flex gap-3 pt-4">
                        <button onClick={() => onSave(formData)} className="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold">保存</button>
                        <button onClick={onCancel} className="flex-1 bg-white/10 hover:bg-white/20 text-gray-300 py-2 rounded-lg">取消</button>
                    </div>
                </div>
            );
        };

        const CategoryManager = ({ category, onUpdate, onDeleteRequest }) => {
            const [isEditingLink, setIsEditingLink] = useState(false);
            const [currentLinkIndex, setCurrentLinkIndex] = useState(null);
            const [links, setLinks] = useState(category.links || []);
            const [deleteConfirmIndex, setDeleteConfirmIndex] = useState(null);

            const handleSaveLink = (linkData) => {
                let newLinks = [...links];
                if (currentLinkIndex !== null) {
                    newLinks[currentLinkIndex] = linkData;
                } else {
                    newLinks.push(linkData);
                }
                setLinks(newLinks);
                onUpdate({ ...category, links: newLinks }); 
                setIsEditingLink(false);
                setCurrentLinkIndex(null);
            };

            const handleDeleteLink = (index) => {
                if (deleteConfirmIndex === index) {
                    const newLinks = links.filter((_, i) => i !== index);
                    setLinks(newLinks);
                    onUpdate({ ...category, links: newLinks });
                    setDeleteConfirmIndex(null);
                } else {
                    setDeleteConfirmIndex(index);
                    setTimeout(() => setDeleteConfirmIndex(null), 3000);
                }
            };

            if (isEditingLink) {
                return <LinkEditor 
                    link={currentLinkIndex !== null ? links[currentLinkIndex] : null} 
                    onSave={handleSaveLink} 
                    onCancel={() => { setIsEditingLink(false); setCurrentLinkIndex(null); }} 
                />;
            }

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center bg-white/5 p-3 rounded-lg border border-white/5">
                         <div>
                            <h4 className="font-bold text-white">{category.title}</h4>
                            <p className="text-xs text-gray-500">{links.length} 个链接</p>
                        </div>
                        <button onClick={() => onDeleteRequest(category.id)} className="text-red-400 hover:text-red-300 text-xs px-3 py-1.5 bg-red-500/10 rounded border border-red-500/20 transition-colors">
                            删除分类
                        </button>
                    </div>

                    <div className="space-y-3">
                         <div className="flex justify-between items-center">
                            <h5 className="text-sm font-bold text-gray-400">链接列表</h5>
                            <button onClick={() => { setCurrentLinkIndex(null); setIsEditingLink(true); }} className="text-xs bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded shadow-lg shadow-blue-900/50">
                                + 添加链接
                            </button>
                        </div>
                        <div className="grid gap-2 max-h-[400px] overflow-y-auto pr-1">
                            {links.map((link, idx) => {
                                const isImage = link.icon && (link.icon.startsWith('http') || link.icon.startsWith('data:'));
                                return (
                                    <div key={idx} className="flex items-center gap-3 bg-white/5 p-2 rounded hover:bg-white/10 transition-colors group">
                                        <div className={`w-8 h-8 rounded flex items-center justify-center text-xs ${link.color}`}>
                                            {isImage ? <img src={link.icon} className="w-5 h-5 object-contain" /> : <i className={link.icon}></i>}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="text-sm text-white truncate">{link.name}</div>
                                            <div className="text-xs text-gray-500 truncate">{link.url}</div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            {deleteConfirmIndex === idx ? (
                                                <div className="flex gap-2 animate-pulse">
                                                     <button onClick={() => setDeleteConfirmIndex(null)} className="text-xs text-gray-400 hover:text-white px-2">取消</button>
                                                     <button onClick={() => handleDeleteLink(idx)} className="text-xs bg-red-600 text-white px-2 py-1 rounded font-bold">确定?</button>
                                                </div>
                                            ) : (
                                                <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onClick={() => { setCurrentLinkIndex(idx); setIsEditingLink(true); }} className="w-7 h-7 flex items-center justify-center rounded bg-blue-500/10 text-blue-400 hover:bg-blue-500/20"><i className="fa-solid fa-pen text-xs"></i></button>
                                                    <button onClick={() => handleDeleteLink(idx)} className="w-7 h-7 flex items-center justify-center rounded bg-red-500/10 text-red-400 hover:bg-red-500/20"><i className="fa-solid fa-trash text-xs"></i></button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                            {links.length === 0 && <div className="text-center text-gray-500 text-sm py-4">暂无链接</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [categories, setCategories] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isAdmin, setIsAdmin] = useState(false);
            const [editingCategory, setEditingCategory] = useState(null);
            const [showAddCategory, setShowAddCategory] = useState(false);
            const [newCatTitle, setNewCatTitle] = useState('');
            const [newCatColor, setNewCatColor] = useState('text-blue-400');
            const [toast, setToast] = useState(null); 
            const [deleteConfirm, setDeleteConfirm] = useState({ show: false, catId: null });

            const fetchCategories = async () => {
                setLoading(true);
                const { data, error } = await supabase.from('categories').select('*').order('order', { ascending: true });
                if (error) { console.error('Error fetching:', error); setToast({ message: '数据加载失败', type: 'error' }); }
                else { setCategories(data || []); }
                setLoading(false);
            };

            useEffect(() => { fetchCategories(); }, []);

            const handleAddCategory = async () => {
                if (!newCatTitle.trim()) return;
                const newOrder = categories.length > 0 ? Math.max(...categories.map(c => c.order)) + 1 : 1;
                const { data, error } = await supabase.from('categories').insert([{ title: newCatTitle, color: newCatColor, order: newOrder, links: [] }]).select();
                if (!error && data) {
                    setCategories([...categories, data[0]]); setShowAddCategory(false); setNewCatTitle(''); setToast({ message: '分类创建成功', type: 'success' });
                } else { setToast({ message: '创建失败: ' + error.message, type: 'error' }); }
            };

            const handleDeleteCategoryConfirm = async () => {
                const id = deleteConfirm.catId;
                const { error } = await supabase.from('categories').delete().eq('id', id);
                if (!error) {
                    setCategories(categories.filter(c => c.id !== id)); setEditingCategory(null); setDeleteConfirm({ show: false, catId: null }); setToast({ message: '分类已删除', type: 'success' });
                } else { setToast({ message: '删除失败: ' + error.message, type: 'error' }); setDeleteConfirm({ show: false, catId: null }); }
            };

            const handleUpdateCategory = async (updatedCat) => {
                setCategories(categories.map(c => c.id === updatedCat.id ? updatedCat : c));
                const { error } = await supabase.from('categories').upsert({ id: updatedCat.id, title: updatedCat.title, color: updatedCat.color, links: updatedCat.links, order: updatedCat.order });
                if (error) { console.error('Update failed:', error); fetchCategories(); setToast({ message: '保存失败', type: 'error' }); }
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto relative">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    <ConfirmModal isOpen={deleteConfirm.show} title="删除分类确认" message="您确定要删除这个分类吗？该分类下的所有链接也将被永久删除，此操作无法恢复。" onCancel={() => setDeleteConfirm({ show: false, catId: null })} onConfirm={handleDeleteCategoryConfirm} />
                    
                    <header className="flex justify-between items-center mb-10 px-2">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-gradient-to-tr from-blue-600 to-cyan-400 rounded-xl flex items-center justify-center text-white text-lg shadow-lg shadow-blue-500/20"><i className="fa-solid fa-house"></i></div>
                            <h1 className="text-2xl font-bold tracking-tight text-white">MyNav <span className="text-xs opacity-50 font-normal ml-2">{isAdmin ? '(管理模式)' : ''}</span></h1>
                        </div>
                        <div className="flex gap-4">
                           <button onClick={() => setIsAdmin(!isAdmin)} className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${isAdmin ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/50' : 'bg-white/10 text-gray-400 hover:bg-white/20'}`}><i className={`fa-solid ${isAdmin ? 'fa-check' : 'fa-gear'}`}></i></button>
                        </div>
                    </header>

                    {loading ? (
                        <div className="text-center text-gray-500 mt-20"><i className="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i><p>正在连接 Supabase 云端数据...</p></div>
                    ) : (
                        <>
                            {!isAdmin && (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12 animate-fade-in-up"><TimeWidget /><DateWidget /><SearchWidget /></div>)}
                            <div className="space-y-10 pb-20">
                                {categories.map(category => (
                                    <section key={category.id} className="relative group/section">
                                        <div className="flex items-center gap-2 mb-4 px-2">
                                            <h2 className={`text-xl font-bold ${category.color} flex items-center gap-2`}>{category.title}<span className="bg-white/10 text-xs px-2 py-0.5 rounded-full text-gray-400 font-mono">{(category.links || []).length}</span></h2>
                                            <div className="h-[1px] bg-gradient-to-r from-gray-700 to-transparent flex-grow ml-4 opacity-50"></div>
                                            {isAdmin && (<button onClick={() => setEditingCategory(category)} className="text-xs bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-full transition-colors ml-2"><i className="fa-solid fa-pen-to-square mr-1"></i> 管理</button>)}
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                                            {(category.links || []).map((link, idx) => (<LinkCard key={idx} link={link} />))}
                                            {isAdmin && (<button onClick={() => setEditingCategory(category)} className="glass-panel p-4 rounded-xl flex flex-col items-center justify-center gap-2 border-dashed border-2 border-white/10 hover:border-white/30 hover:bg-white/5 transition-all h-[88px] text-gray-500 hover:text-white"><i className="fa-solid fa-plus text-xl"></i><span className="text-xs">管理 / 添加</span></button>)}
                                        </div>
                                    </section>
                                ))}
                                {isAdmin && (<button onClick={() => setShowAddCategory(true)} className="w-full py-4 border-2 border-dashed border-white/10 rounded-xl text-gray-500 hover:text-white hover:border-white/30 hover:bg-white/5 transition-all flex items-center justify-center gap-2"><i className="fa-solid fa-folder-plus"></i> 添加新分类</button>)}
                                {categories.length === 0 && !loading && (<div className="text-center py-20 bg-white/5 rounded-2xl border border-dashed border-white/10"><p className="text-gray-400 mb-2">暂无数据</p><p className="text-xs text-gray-600 mb-4">请确保已在 Supabase 运行建表 SQL</p>{isAdmin && <button onClick={() => setShowAddCategory(true)} className="bg-blue-600 px-4 py-2 rounded text-white text-sm">创建第一个分类</button>}</div>)}
                            </div>
                        </>
                    )}
                    <footer className="py-8 text-center text-gray-600 text-sm border-t border-white/5"><p>© 2025 MyNav. Powered by React & Supabase.</p></footer>
                    {editingCategory && (<AdminModal title={`管理: ${editingCategory.title}`} onClose={() => setEditingCategory(null)}><CategoryManager category={editingCategory} onUpdate={handleUpdateCategory} onDeleteRequest={(id) => setDeleteConfirm({ show: true, catId: id })} /></AdminModal>)}
                    {showAddCategory && (<AdminModal title="新建分类" onClose={() => setShowAddCategory(false)}><div className="space-y-4"><div><label className="block text-xs text-gray-400 mb-1">分类名称</label><input type="text" className="admin-input" autoFocus value={newCatTitle} onChange={e => setNewCatTitle(e.target.value)} placeholder="例如: 常用工具" /></div><div><label className="block text-xs text-gray-400 mb-1">标题颜色</label><div className="flex flex-wrap gap-2">{colorOptions.map(opt => (<button key={opt.text} onClick={() => setNewCatColor(opt.text)} className={`w-8 h-8 rounded-full ${opt.bg} ${newCatColor === opt.text ? 'ring-2 ring-white ring-offset-2 ring-offset-black' : 'opacity-70 hover:opacity-100'}`} title={opt.label}></button>))}</div></div><button onClick={handleAddCategory} className="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold mt-4">创建分类</button></div></AdminModal>)}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>